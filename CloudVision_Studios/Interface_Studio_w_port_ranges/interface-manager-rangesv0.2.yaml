# This is the Device Interface Studio
#
-   service: arista.studio.v1.StudioConfigService
    method: Set
    body:
        value:
            key:
                studio_id: studio-interface-manager
                workspace_id: &workspace_id ws-interface-manager
            display_name: 'Interface Configuration'
            description: "Configure device interfaces and interface profiles, and assign administrative state, VLANs, and other attributes"

-   service: arista.studio.v1.StudioConfigService
    method: Set
    body:
        value:
            key:
                studio_id: studio-interface-manager
                workspace_id: *workspace_id
            input_schema:
                fields:
                    values:
                        enabled:
                            id: enabled
                            name: enabled
                            label: Enabled
                            description: 'Enable or disable the interface for adminstration'
                            required: false
                            type: INPUT_FIELD_TYPE_BOOLEAN
                            boolean_props:
                                default_value: false
                        description:
                            id: description
                            name: description
                            label: Description
                            description: 'Enter a port description string (max. 30 characters)'
                            required: false
                            type: INPUT_FIELD_TYPE_STRING
                            string_props:
                                default_value: null
                                static_options: null
                                format: null
                                length: null
                                pattern: null
                                dynamic_options: null
                        accessVlan:
                            id: accessVlan
                            name: accessVlan
                            label: 'Access VLAN ID'
                            description: 'Enter the VLAN ID for this port'
                            required: false
                            type: INPUT_FIELD_TYPE_INTEGER
                            integer_props:
                                default_value: null
                                range: 0..4094
                                static_options: null
                                dynamic_options: null
                        speed:
                            id: speed
                            name: speed
                            label: 'Interface Speed'
                            description: 'Set the interface speed'
                            required: false
                            type: INPUT_FIELD_TYPE_STRING
                            string_props:
                                default_value: null
                                static_options:
                                    values:
                                        - auto
                                        - 10half
                                        - 10full
                                        - 100full
                                        - 1gfull
                                        - 10gfull
                                        - 25gfull
                                        - 40gfull
                                        - 100gfull
                                format: null
                                length: null
                                pattern: null
                                dynamic_options: null
                        profile:
                            id: profile
                            name: profile
                            label: Profile
                            description: 'Assign an interface profile that you''ve created to this device interface'
                            required: false
                            type: INPUT_FIELD_TYPE_STRING
                            string_props:
                                default_value: null
                                static_options: null
                                format: null
                                length: null
                                pattern: null
                                dynamic_options:
                                    values:
                                        - '{"fieldId":"profileName"}'
                        channelGroup:
                            id: channelGroup
                            name: channelGroup
                            label: 'Port Channel Group'
                            description: 'Enter a Port Channel ID if this interface is in a Link Aggregation Group (LAG)'
                            required: false
                            type: INPUT_FIELD_TYPE_INTEGER
                            integer_props:
                                default_value: null
                                range: 0..999999
                                static_options: null
                                dynamic_options: null
                        mlagEnabled:
                            id: mlagEnabled
                            name: mlagEnabled
                            label: 'Enable MLAG'
                            description: 'Enable or disable the MLAG ID if this interface is in a Link Aggregation Group (LAG)'
                            required: false
                            type: INPUT_FIELD_TYPE_BOOLEAN
                            boolean_props:
                                default_value: false
                        intfConfig:
                            id: intfConfig
                            name: intfConfig
                            label: 'Interface specific configuration'
                            description: ""
                            required: false
                            type: INPUT_FIELD_TYPE_GROUP
                            group_props:
                                members:
                                    values:
                                        - enabled
                                        - description
                                        - accessVlan
                                        - speed
                                        - profile
                                        - channelGroup
                                        - mlagEnabled
                        interface:
                            id: interface
                            name: interface
                            label: Interface
                            description: "Configure the device's interface attributes."
                            required: false
                            type: INPUT_FIELD_TYPE_RESOLVER
                            resolver_props:
                                base_field_id: intfConfig
                                display_mode: RESOLVER_FIELD_DISPLAY_MODE_ALL
                                input_mode: RESOLVER_FIELD_INPUT_MODE_SINGLE_INTERFACE_TAG
                                input_tag_label: interface
                                tag_filter_query: null
                        e312232e-c8b1-40a4-96b6-fef7cd7bc67b:
                            id: e312232e-c8b1-40a4-96b6-fef7cd7bc67b
                            name: devicesGroup
                            label: Devices Group
                            description: ''
                            required: false
                            type: INPUT_FIELD_TYPE_GROUP
                            group_props:
                                members:
                                    values:
                                        - 1272ed58-34c1-4524-a620-e2cfff28d95e
                                        - interface
                        devices:
                            id: devices
                            name: devices
                            label: Device
                            description: 'Select a device to configure its interfaces and to assign a profile.'
                            required: false
                            type: INPUT_FIELD_TYPE_RESOLVER
                            resolver_props:
                                base_field_id: e312232e-c8b1-40a4-96b6-fef7cd7bc67b
                                display_mode: RESOLVER_FIELD_DISPLAY_MODE_SPARSE
                                input_mode: RESOLVER_FIELD_INPUT_MODE_MULTI_DEVICE_TAG
                                input_tag_label: null
                                tag_filter_query: null
                        profileName:
                            id: profileName
                            name: name
                            label: Name
                            description: ""
                            required: false
                            type: INPUT_FIELD_TYPE_STRING
                            string_props:
                                default_value: null
                                static_options: null
                                format: null
                                length: null
                                pattern: null
                                dynamic_options: null
                        profileDescription:
                            id: profileDescription
                            name: profileDescription
                            label: 'Profile Description'
                            description: 'Create a description for this profile. Entering "$1" will add the device interface description when applied to a device.'
                            required: false
                            type: INPUT_FIELD_TYPE_STRING
                            string_props:
                                default_value: null
                                static_options: null
                                format: null
                                length: null
                                pattern: null
                                dynamic_options: null
                        profileSpeed:
                            id: profileSpeed
                            name: speed
                            label: Speed
                            description: 'Set the speed of the interface.'
                            required: false
                            type: INPUT_FIELD_TYPE_STRING
                            string_props:
                                default_value: null
                                static_options:
                                    values:
                                        - auto
                                        - 10half
                                        - 10full
                                        - 100full
                                        - 1gfull
                                        - 10gfull
                                        - 25gfull
                                        - 40gfull
                                        - 100gfull
                                format: null
                                length: null
                                pattern: null
                                dynamic_options: null
                        mode:
                            id: mode
                            name: mode
                            label: Mode
                            description: 'Set this as a VLAN access interface, as a trunk interface, a routed interface, or as a phone interface for VLAN unaware IP phones.'
                            required: false
                            type: INPUT_FIELD_TYPE_STRING
                            string_props:
                                default_value: access
                                static_options:
                                    values:
                                        - access
                                        - trunk
                                        - routed
                                        - phone
                                format: null
                                length: null
                                pattern: null
                                dynamic_options: null
                        accessVlanId:
                            id: accessVlanId
                            name: accessVlanId
                            label: 'Access VLAN ID'
                            description: ""
                            required: false
                            type: INPUT_FIELD_TYPE_INTEGER
                            integer_props:
                                default_value: null
                                range: 0..4094
                                static_options: null
                                dynamic_options: null
                        nativeVlanId:
                            id: nativeVlanId
                            name: nativeVlanId
                            label: 'Native VLAN ID'
                            description: 'Assign a VLAN that untagged traffic arriving on this trunk will be tagged with.'
                            required: false
                            type: INPUT_FIELD_TYPE_INTEGER
                            integer_props:
                                default_value: '1'
                                range: 0..4094
                                static_options: null
                                dynamic_options: null
                        phoneVlanId:
                            id: phoneVlanId
                            name: phoneVlanId
                            label: 'Phone VLAN ID'
                            description: 'VoIP VLAN that enables LLDP-based classification of IP phones using the Type 7 System Capabilities TLV.'
                            required: false
                            type: INPUT_FIELD_TYPE_INTEGER
                            integer_props:
                                default_value: '0'
                                range: 0..4094
                                static_options: null
                                dynamic_options: null
                        allowedVlans:
                            id: allowedVlans
                            name: allowedVlans
                            label: 'Allowed VLANs'
                            description: 'List the VLAN IDs that this trunk can carry. Separate values with a comma and including continuous values with a hyphen (e.g. 4, 10-16, 100).'
                            required: false
                            type: INPUT_FIELD_TYPE_STRING
                            string_props:
                                default_value: null
                                static_options: null
                                format: null
                                length: null
                                pattern: null
                                dynamic_options: null
                        profilePortFastEnabled:
                            id: profilePortFastEnabled
                            name: portFastEnabled
                            label: 'Enable spanning-tree portfast'
                            description: 'Enable or disable spanning-tree portfast for a switchport'
                            required: false
                            type: INPUT_FIELD_TYPE_BOOLEAN
                            boolean_props:
                                default_value: true
                        ipaddress:
                            id: ipaddress
                            name: ipaddress
                            label: 'Routed Port IP Address and Subnet Mask'
                            description: 'Enter in CIDR notation'
                            required: false
                            type: INPUT_FIELD_TYPE_STRING
                            string_props:
                                default_value: null
                                static_options: null
                                format: cidr
                                length: null
                                pattern: null
                                dynamic_options: null
                        ipmtu:
                            id: ipmtu
                            name: ipmtu
                            label: 'Routed Port MTU'
                            description: 'Enter the MTU for the Routed Port'
                            required: false
                            type: INPUT_FIELD_TYPE_INTEGER
                            integer_props:
                                default_value: null
                                range: 68..65535
                                static_options: null
                                dynamic_options: null
                        profileChannelGroup:
                            id: profileChannelGroup
                            name: channelGroup
                            label: 'Port Channel Group'
                            description: 'Enter a Port Channel ID if the interface is in a Link Aggregation Group (LAG)'
                            required: false
                            type: INPUT_FIELD_TYPE_INTEGER
                            integer_props:
                                default_value: null
                                range: 0..999999
                                static_options: null
                                dynamic_options: null
                        profileMlagEnabled:
                            id: profileMlagEnabled
                            name: mlagEnabled
                            label: 'Enable MLAG'
                            description: 'Enable or disable the MLAG ID on the Link Aggregation Group (LAG)'
                            required: false
                            type: INPUT_FIELD_TYPE_BOOLEAN
                            boolean_props:
                                default_value: false
                        profileLACPEnabled:
                            id: profileLACPEnabled
                            name: lacpEnabled
                            label: 'Enable LACP'
                            description: 'Enable or disable the LACP mode on the member ports of the Link Aggregation Group (LAG)'
                            required: false
                            type: INPUT_FIELD_TYPE_BOOLEAN
                            boolean_props:
                                default_value: true
                        profileValue:
                            id: profileValue
                            name: value
                            label: 'Profiles Group'
                            description: 'Group of members for Profiles'
                            required: false
                            type: INPUT_FIELD_TYPE_GROUP
                            group_props:
                                members:
                                    values:
                                        - profileName
                                        - profileDescription
                                        - profileSpeed
                                        - mode
                                        - accessVlanId
                                        - nativeVlanId
                                        - phoneVlanId
                                        - allowedVlans
                                        - profilePortFastEnabled
                                        - ipaddress
                                        - ipmtu
                                        - profileChannelGroup
                                        - profileMlagEnabled
                                        - profileLACPEnabled
                        profiles:
                            id: profiles
                            name: profiles
                            label: Profile
                            description: 'Create or edit profiles to share interface attributes across devices.'
                            required: false
                            type: INPUT_FIELD_TYPE_COLLECTION
                            collection_props:
                                base_field_id: profileValue
                                key: profileName
                        83957a33-96fb-424e-a49e-b68dba720da5:
                            id: 83957a33-96fb-424e-a49e-b68dba720da5
                            name: interfaceName
                            label: InterfaceName
                            description: ''
                            required: false
                            type: INPUT_FIELD_TYPE_STRING
                            string_props:
                                default_value: null
                                static_options: null
                                format: null
                                length: null
                                pattern: null
                                dynamic_options: null
                        83829c03-f581-402d-ba99-ee71d21c6a40:
                            id: 83829c03-f581-402d-ba99-ee71d21c6a40
                            name: profile
                            label: Profile
                            description: ''
                            required: false
                            type: INPUT_FIELD_TYPE_STRING
                            string_props:
                                default_value: null
                                static_options: null
                                format: null
                                length: null
                                pattern: null
                                dynamic_options:
                                    values:
                                        - '{"fieldId":"profileName"}'
                        e6e1aaee-ffb5-4b12-b2b1-5348b11cde18:
                            id: e6e1aaee-ffb5-4b12-b2b1-5348b11cde18
                            name: description
                            label: Description
                            description: ''
                            required: false
                            type: INPUT_FIELD_TYPE_STRING
                            string_props:
                                default_value: null
                                static_options: null
                                format: null
                                length: null
                                pattern: null
                                dynamic_options: null
                        0700b440-440a-4db8-87f6-9087e1cd1f57:
                            id: 0700b440-440a-4db8-87f6-9087e1cd1f57
                            name: accessVlan
                            label: Access VLAN ID
                            description: ''
                            required: false
                            type: INPUT_FIELD_TYPE_INTEGER
                            integer_props:
                                default_value: null
                                range: null
                                static_options: null
                                dynamic_options: null
                        beb2a016-56d0-484f-9e7e-390f837cf8e6:
                            id: beb2a016-56d0-484f-9e7e-390f837cf8e6
                            name: interfaceSpeed
                            label: Interface Speed
                            description: ''
                            required: false
                            type: INPUT_FIELD_TYPE_STRING
                            string_props:
                                default_value: auto
                                static_options:
                                    values:
                                        - auto
                                        - 10half
                                        - 10full
                                        - 100full
                                        - 1gfull
                                        - 10gfull
                                        - 25gfull
                                        - 40gfull
                                        - 100gfull
                                format: null
                                length: null
                                pattern: null
                                dynamic_options: null
                        c0d6733b-41f3-4f89-866f-af7ffef57d1d:
                            id: c0d6733b-41f3-4f89-866f-af7ffef57d1d
                            name: portChannelGroup
                            label: Port-Channel Group
                            description: ''
                            required: false
                            type: INPUT_FIELD_TYPE_STRING
                            string_props:
                                default_value: null
                                static_options: null
                                format: null  
                                length: null
                                pattern: null
                                dynamic_options: null
                        d2bc2f59-9e84-4681-8632-de95d3454a61:
                            id: d2bc2f59-9e84-4681-8632-de95d3454a61
                            name: enabled
                            label: Enabled
                            description: ''
                            required: false
                            type: INPUT_FIELD_TYPE_BOOLEAN
                            boolean_props:
                                default_value: false
                        fff9af94-c57d-44a2-b27e-a7dda0ce7c00:
                            id: fff9af94-c57d-44a2-b27e-a7dda0ce7c00
                            name: interfaceRangesGroup
                            label: Interface Ranges Group
                            description: ''
                            required: false
                            type: INPUT_FIELD_TYPE_GROUP
                            group_props:
                                members:
                                    values:
                                        - 83957a33-96fb-424e-a49e-b68dba720da5
                                        - 83829c03-f581-402d-ba99-ee71d21c6a40
                                        - e6e1aaee-ffb5-4b12-b2b1-5348b11cde18
                                        - 0700b440-440a-4db8-87f6-9087e1cd1f57
                                        - beb2a016-56d0-484f-9e7e-390f837cf8e6
                                        - c0d6733b-41f3-4f89-866f-af7ffef57d1d
                                        - d2bc2f59-9e84-4681-8632-de95d3454a61
                        1272ed58-34c1-4524-a620-e2cfff28d95e:
                            id: 1272ed58-34c1-4524-a620-e2cfff28d95e
                            name: interfaceRanges
                            label: Interface Ranges
                            description: ''
                            required: false
                            type: INPUT_FIELD_TYPE_COLLECTION
                            collection_props:
                                base_field_id: fff9af94-c57d-44a2-b27e-a7dda0ce7c00
                                key: ''
                        root:
                            id: root
                            name: ""
                            label: ""
                            description: ""
                            required: false
                            type: INPUT_FIELD_TYPE_GROUP
                            group_props:
                                members:
                                    values:
                                        - profiles
                                        - devices
                layout:
                    value: |
                      {
                        "accessVlanId": {
                           "key": "accessVlanId",
                           "dependency": {
                              "mode": {
                                 "value": [
                                    "access"
                                 ],
                                 "mode": "SHOW"
                              }
                           },
                           "type": "INPUT"
                        },
                        "nativeVlanId": {
                           "key": "nativeVlanId",
                           "dependency": {
                              "mode": {
                                 "value": [
                                    "trunk",
                                    "phone"
                                 ],
                                 "mode": "SHOW"
                              }
                           },
                           "type": "INPUT"
                        },
                        "allowedVlans": {
                           "key": "allowedVlans",
                           "dependency": {
                              "mode": {
                                 "value": [
                                    "trunk",
                                    "phone"
                                 ],
                                 "mode": "SHOW"
                              }
                           },
                           "type": "INPUT"
                        },
                        "phoneVlanId": {
                           "key": "phoneVlanId",
                           "dependency": {
                              "mode": {
                                 "value": [
                                    "phone"
                                 ],
                                 "mode": "SHOW"
                              }
                           },
                           "type": "INPUT"
                        },
                        "ipaddress": {
                           "key": "ipaddress",
                           "dependency": {
                              "mode": {
                                 "value": [
                                    "routed"
                                 ],
                                 "mode": "SHOW"
                              }
                           },
                           "type": "INPUT"
                        },
                        "ipmtu": {
                           "key": "ipmtu",
                           "dependency": {
                              "mode": {
                                 "value": [
                                    "routed"
                                 ],
                                 "mode": "SHOW"
                              }
                           },
                           "type": "INPUT"
                        },
                        "profilePortFastEnabled": {
                           "key": "profilePortFastEnabled",
                           "dependency": {
                              "mode": {
                                 "value": [
                                    "access",
                                    "trunk",
                                    "phone"
                                 ],
                                 "mode": "SHOW"
                              }
                           },
                           "type": "INPUT"
                        },
                        "profileMlagEnabled": {
                           "key": "profileMlagEnabled",
                           "dependency": {
                              "profileChannelGroup": {
                                 "value": [
                                    "__ANY__"
                                 ],
                                 "mode": "SHOW"
                              },
                              "mode": {
                                 "value": [
                                    "access",
                                    "trunk",
                                    "phone"
                                 ],
                                 "mode": "SHOW"
                              }
                           },
                           "type": "INPUT",
                           "dependencyType": "AND"
                        },
                        "profileLACPEnabled": {
                           "key": "profileLACPEnabled",
                           "dependency": {
                              "profileChannelGroup": {
                                 "value": [
                                    "__ANY__"
                                 ],
                                 "mode": "SHOW"
                              }
                           },
                           "type": "INPUT"
                        },
                        "intfConfig": {
                           "key": "intfConfig",
                           "type": "INPUT",
                           "order": [
                              "enabled",
                              "profile",
                              "description",
                              "accessVlan",
                              "speed",
                              "channelGroup",
                              "mlagEnabled"
                           ]
                        },
                        "profiles": {
                           "key": "profiles",
                           "type": "INPUT",
                           "isPageLayout": true
                        },
                        "fff9af94-c57d-44a2-b27e-a7dda0ce7c00": {
                           "key": "fff9af94-c57d-44a2-b27e-a7dda0ce7c00",
                           "type": "INPUT",
                           "order": [
                              "83957a33-96fb-424e-a49e-b68dba720da5",
                              "d2bc2f59-9e84-4681-8632-de95d3454a61",
                              "83829c03-f581-402d-ba99-ee71d21c6a40",
                              "e6e1aaee-ffb5-4b12-b2b1-5348b11cde18",
                              "0700b440-440a-4db8-87f6-9087e1cd1f57",
                              "beb2a016-56d0-484f-9e7e-390f837cf8e6",
                              "c0d6733b-41f3-4f89-866f-af7ffef57d1d"
                           ]
                        }
                      }

-   service: arista.studio.v1.StudioConfigService
    method: Set
    body:
        value:
            key:
                studio_id: studio-interface-manager
                workspace_id: *workspace_id
            template:
                type: TEMPLATE_TYPE_MAKO
                body: |
                    <%
                    debug = False
                    class baseInterface:
                      def __init__(self):
                        self.enabled = None
                        self.mode = None
                        self.accessVlan = None
                        self.desc = None
                        self.nativeVlanId = None
                        self.allowedVlans = None
                        self.phoneVlanId = None
                        self.portFastEnabled = None
                        self.ipaddress = None
                        self.ipmtu = None
                    class interface(baseInterface):
                      def __init__(self):
                        super().__init__()
                        self.speed = None
                        self.groupNum = None
                        self.lacpEnabled = True
                    class channelGroup(baseInterface):
                      def __init__(self):
                        super().__init__()
                        self.mlagEnabled = None

                    def processInterface(intfName, intfCfg, profileCfg):
                      intf = interfaces.get(intfName, interface())
                      intf.enabled = intfCfg.get('enabled')
                      intf.speed = intfCfg.get('speed')
                      intf.groupNum = intfCfg.get('channelGroup')
                      accessVlan = intfCfg.get('accessVlan')
                      mode = 'access' if accessVlan else None
                      desc = intfCfg.get('description')
                      group = None
                      if profileCfg:
                          if not intf.speed:
                              intf.speed = profileCfg.get('speed')
                          intf.groupNum = intf.groupNum or profileCfg.get('channelGroup')
                          profileMode = profileCfg.get('mode')
                          if mode == 'access':
                              assert profileMode == 'access', 'Interface %s: Access VLAN cannot be specified along with profile %s' %(intfName, profileMode)
                          else:
                              mode = profileMode
                          if mode == 'access':
                              accessVlan = accessVlan or profileCfg.get('accessVlanId')
                              assert accessVlan > 0, 'Interface %s: Access Vlan must be specified for access mode' %(intfName)
                          if mode != 'routed':
                              intf.portFastEnabled = intf.portFastEnabled or profileCfg.get('portFastEnabled')
                          else:
                              intf.ipaddress = intf.ipaddress or profileCfg.get('ipaddress')
                              intf.ipmtu = intf.ipmtu or profileCfg.get('ipmtu')

                          profileDesc = profileCfg.get('profileDescription')
                          if profileDesc:
                              if '$1' in profileDesc:
                                  if not desc:
                                      raise Exception('Interface %s is missing a description, '
                                          'needed for the profile %r template' % (intfName, profileName))
                                  desc = profileDesc.replace('$1', desc)
                              else:
                                  desc = profileDesc
                      if intf.groupNum:
                          mlagEnabled = None
                          group = groups.get(intf.groupNum, channelGroup())
                          group.enabled = True
                          group.mode = mode
                          group.accessVlan = accessVlan
                          if profileCfg:
                              group.nativeVlanId = profileCfg.get('nativeVlanId')
                              group.allowedVlans = profileCfg.get('allowedVlans')
                              group.phoneVlanId = profileCfg.get('phoneVlanId')
                              if group.mode != 'routed':
                                  group.portFastEnabled = group.portFastEnabled or profileCfg.get('portFastEnabled')
                              else:
                                  group.ipaddress = group.ipaddress or profileCfg.get('ipaddress')
                                  group.ipmtu = group.ipmtu or profileCfg.get('ipmtu')
                              mlagEnabled = profileCfg.get('mlagEnabled')
                              intf.lacpEnabled = profileCfg.get('lacpEnabled')
                          group.desc = desc
                          intf.desc = intfCfg.get('description')
                          group.mlagEnabled = mlagEnabled or intfCfg.get('mlagEnabled')
                      else:
                          intf.mode = mode
                          intf.accessVlan = accessVlan
                          intf.nativeVlanId = profileCfg.get('nativeVlanId') if profileCfg else None
                          intf.allowedVlans = profileCfg.get('allowedVlans') if profileCfg else None
                          intf.phoneVlanId = profileCfg.get('phoneVlanId') if profileCfg else None
                          intf.desc = desc
                      interfaces[intfName] = intf
                      if group:
                        groups[intf.groupNum] = group

                    if not profiles and not devices:
                      return
                    my_device = ctx.getDevice()
                    groups = {}
                    interfaces = {}
                    ### Interface Ranges
                    for intfRange in devices.resolve().devicesGroup.interfaceRanges:
                        intfName = intfRange["interfaceName"]
                        intfCfg = intfRange
                        ## Don't output config if nothing interesting is set
                        if len(intfCfg) == 0 or not intfCfg.get('enabled'):
                          continue
                        profileName = intfCfg.get('profile')
                        matchedProfile = None
                        if profileName:
                            matchedProfile = next((p for p in profiles if profileName == p['name']), None)
                            if not matchedProfile:
                                raise Exception('Found no matching profile "%s" for interface %s' % (profileName, intfName))
                        processInterface(intfName, intfCfg, matchedProfile)
                    for intf in my_device.getInterfaces():
                        intfName = intf.name
                        intfVal = devices.resolve().devicesGroup.interface.resolve(intfName, strict=True)
                        if not intfVal or not intfVal.get('intfConfig'):
                            continue
                        intfCfg = intfVal['intfConfig']
                        ## Don't output config if nothing interesting is set
                        if len(intfCfg) == 0 or not intfCfg.get('enabled'):
                          continue
                        # Note: we are not using the EOS 'interface profiles' feature for now because of
                        # they make config pushes slow in certain releases (519556).
                        profileName = intfCfg.get('profile')
                        matchedProfile = None
                        if profileName:
                            matchedProfile = next((p for p in profiles if profileName == p['name']), None)
                            if not matchedProfile:
                                raise Exception('Found no matching profile "%s" for interface %s' % (profileName, intfName))
                        processInterface(intfName, intfCfg, matchedProfile)
                    %>\

                    <%def name="makeIntfCfg(intfName, intfCfg)">
                        <%
                          # Interface-specific settings (intfCfg) override profile settings (profileCfg)
                          # Speed is always taken from profile if not set at interface level.
                          # Description is always taken from profile, and template-substituted with interface description
                        %>
                    interface ${intfName}
                      %if intfCfg.enabled:
                        no shutdown
                      %endif
                      %if intfCfg.mode == 'access':
                        switchport
                        switchport mode access
                        switchport access vlan ${intfCfg.accessVlan}
                      %elif intfCfg.mode == 'trunk':
                        switchport
                        switchport mode trunk
                      %    if intfCfg.nativeVlanId:
                        switchport trunk native vlan ${intfCfg.nativeVlanId}
                      %    endif
                      %    if intfCfg.allowedVlans:
                        switchport trunk allowed vlan ${intfCfg.allowedVlans}
                      %    endif
                      %elif intfCfg.mode == 'routed':
                        no switchport
                        no switchport mode
                      %    if intfCfg.ipaddress:
                        ip address ${intfCfg.ipaddress}
                      %    endif
                      %    if intfCfg.ipmtu:
                        mtu ${intfCfg.ipmtu}
                      %    endif
                      %elif intfCfg.mode == 'phone':
                        switchport
                        switchport mode trunk phone
                      %    if intfCfg.nativeVlanId:
                        switchport trunk native vlan ${intfCfg.nativeVlanId}
                      %    endif
                      %    if intfCfg.phoneVlanId:
                        switchport phone vlan ${intfCfg.phoneVlanId}
                      %    endif
                      %    if intfCfg.allowedVlans:
                        switchport trunk allowed vlan ${intfCfg.allowedVlans}
                      %    endif
                      %endif
                      %if intfCfg.portFastEnabled:
                        spanning-tree portfast
                      %endif
                      %if intfCfg.speed == "auto":
                        speed auto
                      %elif intfCfg.speed:
                        speed forced ${intfCfg.speed}
                      %endif
                      %if intfCfg.desc:
                        description ${intfCfg.desc}
                      %endif
                    </%def>\

                    <%def name="makeChannelMemberCfg(intfName, intfCfg)">
                        <%
                          # Simple config for a port channel member interface
                        %>
                    interface ${intfName}
                      %if intfCfg.enabled:
                        no shutdown
                      %endif
                      %if intfCfg.speed == "auto":
                        speed auto
                      %elif intfCfg.speed:
                        speed forced ${intfCfg.speed}
                      %endif
                      %if intfCfg.desc:
                        description ${intfCfg.desc}
                      %endif
                      %if intfCfg.lacpEnabled:
                        channel-group ${intfCfg.groupNum} mode active
                      %else:
                        channel-group ${intfCfg.groupNum} mode on
                      %endif
                    </%def>\

                    <%def name="makeChannelGroupCfg(groupNum, groupCfg)">
                        <%
                          # config for the port channel interfaces
                        %>
                    interface Port-Channel ${groupNum}
                      %if groupCfg.enabled:
                        no shutdown
                      %endif
                      %if groupCfg.mlagEnabled and groupCfg.mode != 'routed':
                        mlag ${groupNum}
                      %endif
                      %if groupCfg.mode == 'access':
                        switchport
                        switchport mode access
                        switchport access vlan ${groupCfg.accessVlan}
                      %elif groupCfg.mode == 'trunk':
                        switchport
                        switchport mode trunk
                      %    if groupCfg.nativeVlanId:
                        switchport trunk native vlan ${groupCfg.nativeVlanId}
                      %    endif
                      %    if groupCfg.allowedVlans:
                        switchport trunk allowed vlan ${groupCfg.allowedVlans}
                      %    endif
                      %elif groupCfg.mode == 'routed':
                        no switchport
                        no switchport mode
                      %    if groupCfg.ipaddress:
                        ip address ${groupCfg.ipaddress}
                      %    endif
                      %    if groupCfg.ipmtu:
                        mtu ${groupCfg.ipmtu}
                      %    endif
                      %elif groupCfg.mode == 'phone':
                        switchport
                        switchport mode trunk phone
                      %    if groupCfg.nativeVlanId:
                        switchport trunk native vlan ${groupCfg.nativeVlanId}
                      %    endif
                      %    if groupCfg.phoneVlanId:
                        switchport phone vlan ${groupCfg.phoneVlanId}
                      %    endif
                      %    if groupCfg.allowedVlans:
                        switchport trunk allowed vlan ${groupCfg.allowedVlans}
                      %    endif
                      %endif
                      %if groupCfg.portFastEnabled:
                        spanning-tree portfast
                      %endif
                      %if groupCfg.desc:
                        description ${groupCfg.desc}
                      %endif
                    </%def>\

                    % for intfName, intfCfg in sorted(interfaces.items()):
                    % if intfCfg.groupNum and intfCfg.groupNum > 0:
                    ${makeChannelMemberCfg(intfName, intfCfg)}
                    % else:
                    ${makeIntfCfg(intfName, intfCfg)}
                    % endif

                    %if debug:
                    % for name, intf in interfaces.items():
                    intf: ${name}, ${vars(intf).items()}
                    % endfor
                    % for num, group in groups.items():
                    group: ${num}, ${vars(group).items()}
                    % endfor
                    %endif
                    % endfor

                    % for groupNum, groupCfg in sorted(groups.items()):
                    ${makeChannelGroupCfg(groupNum, groupCfg)}
                    % endfor
